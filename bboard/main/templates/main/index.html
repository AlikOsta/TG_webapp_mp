{% extends 'layout/basic.html' %}
{% load static %}

{% block link %}
    <link rel="stylesheet" type="text/css" href="{% static 'main/CSS/index.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'main/CSS/slide_rubric.css' %}">
{% endblock %}

{% block content %}
<div class="wr_container">
    <div class="container">
        {% for rubric in rubrics %}
            <a href="{% url 'by_rubric' rubric.id %}">
                <section class="child">
                    <div class="title_rub">{{ rubric.name }}</div>
                    <img class="img_rub" src="{% static 'main/img_cat/cat_' %}{{ rubric.order }}.png">
                </section>
            </a>
        {% endfor %}
    </div>
</div>

<!--Карточки с товаром-->
<div class="wr_content">
    <div id="bb-container" class="wr_card">
        {% include "main/bb_list_ajax.html" with page_obj=page_obj %}
    </div>
</div>

<!--Секция для индикатора загрузки-->
<div id="load-more" data-next-page="{{ page_obj.next_page_number }}">
<!--    <div id="loading" style="display: none;">Загрузка...</div>-->
</div>

<script>
    let isLoading = false;

    const loadMoreData = () => {
        const nextPage = document.getElementById('load-more').getAttribute('data-next-page');
        if (nextPage && !isLoading) {
            isLoading = true;
            // document.getElementById('loading').style.display = 'block';

            fetch(`?page=${nextPage}`, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.text())
            .then(data => {
                const bbContainer = document.getElementById('bb-container');
                bbContainer.innerHTML += data;
                const nextPageNumber = parseInt(nextPage) + 1;
                if (nextPageNumber > {{ page_obj.paginator.num_pages }}) {
                    document.getElementById('load-more').remove();
                } else {
                    document.getElementById('load-more').setAttribute('data-next-page', nextPageNumber);
                }
                isLoading = false;
                // document.getElementById('loading').style.display = 'none';
            });
        }
    };

    window.addEventListener('scroll', () => {
        if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight) {
            loadMoreData();
        }
    });
    
</script>

{% endblock %}
